{% extends "layout.html.jinja" %}

{% block title %}
Alarm Clock Alarms
{% endblock title %}

{% block content %}
    <div class="card bg-dark">
        <div class="card-body">
            <div class="card-title">
                Saved Alarms
            </div>
            <div class="card-text table-responsive">
                <table class="table table-striped table-dark">
                    <thead>
                        <tr>
                            <th>Days</th>
                            <th>Time</th>
                            <th>Enabled</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for alarm in alarms %}
                        <tr>
                            <td>
                                {% for day in days -%}
                                <label for="{{ day }}-{{ alarm['id'] }}">{{ day }}</label>
                                <input type="checkbox" id="{{ day }}-{{ alarm['id'] }}" {{ 'checked' if alarm['days'][day] else '' }} />
                                <br>
                                {% endfor %}
                            </td>
                            <td>
                                <input type="time" id="time-{{ alarm['id'] }}" value="{{ alarm['time'] }}" />
                                {# {% if settings['format'] == '12' and alarm['hour'] == 0 -%}
                                <input type="number" class="time-input" min="1" max="12" id="hour-{{ alarm['id'] }}" value="12" />
                                {% elif settings['format'] == '12' and alarm['hour'] > 12 -%}
                                <input type="number" class="time-input" min="1" max="12" id="hour-{{ alarm['id'] }}" value="{{ '%02i' | format(alarm['hour']-12) }}" />
                                {%- else -%}
                                <input type="number" class="time-input" min="1" max="12" id="hour-{{ alarm['id'] }}" value="{{ '%02i' | format(alarm['hour']) }}" />
                                {%- endif %}
                                :
                                <input type="number" class="time-input" min="0" max="59" id="minute-{{ alarm['id'] }}" value="{{ '%02i' | format(alarm['minute']) }}" />
                                {%- if  settings['format'] == '12' %}
                                <select id="ampm-{{ alarm['id'] }}">
                                    <option value="am"{{ 'selected' if alarm['hour'] < 12 else '' }}>AM</option>
                                    <option value="pm"{{ 'selected' if alarm['hour'] >= 12 else '' }}>PM</option>
                                </select>
                                {% endif %} #}
                            </td>
                            <td>
                                <label for="enabled-{{ alarm['id'] }}">Enabled</label>
                                <input type="checkbox" id="enabled-{{ alarm['id'] }}" {{ 'checked' if alarm['enabled'] else '' }} />
                            </td>
                            <td>
                                <button data-alarm-id="{{ alarm['id'] }}" class="btn btn-primary updateAlarmBtn">Save</button>
                                <button data-alarm-id="{{ alarm['id'] }}" class="btn btn-danger deleteAlarmBtn">Delete</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
{% endblock content %}

{% block mainScript %}

    $('.updateAlarmBtn').click((e) => {
        let id = $(e.target).data('alarmId')

        let days = {}
        {% for day in days -%}
        days.{{ day }} = $(`#{{day}}-${id}`).prop('checked') 
        {% endfor %}
        let enabled = $(`#enabled-${id}`).prop('checked')
        let time = $(`#time-${id}`).val()

        let m = {
            type: "alarms",
            command: "update",
            id,
            days,
            time,
            enabled
        }
        console.log(m)
        ws.send(JSON.stringify(m))
        {# location.reload() #}
    })

    $('#saveNewAlarm').click((e) => {
        e.preventDefault()
        {# let format = $('#format').val() #}
        let m = JSON.stringify({
            "type": "alarms",
            "command": "set"
        })
        ws.send(m)
    })
{% endblock mainScript %}